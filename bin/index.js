import{program as e}from"commander";import r from"chalk";import t from"figlet";import o from"minimist";import{dirname as a}from"node:path";import{fileURLToPath as s}from"node:url";import{relative as n,resolve as i}from"path";import l from"fs-extra";import c from"inquirer";import p from"validate-npm-package-name";import m from"events";import g from"axios";import d from"ora";import u from"download-git-repo";import{promisify as h}from"util";import{execa as w}from"execa";import y from"readline";import{exit as f}from"process";const v=g.create({timeout:6e4,baseURL:"https://api.github.com"});v.interceptors.request.use((e=>e)),v.interceptors.response.use((e=>e.data));const k=async(e,r,...t)=>{const o=d(r);try{o.start();const r=await e(...t);return o.succeed(),r}catch(s){return o.fail("failed to fetch resouorces, retrying..."),await(a=1,new Promise((e=>{setTimeout(e,1e3*a)}))),k(e,r,...t)}var a};const $=(e,r)=>{console.log("render processbar");const t=Math.min(Math.max(e/r,0),1),o=` ${e}/${r}`,a=Math.max(0,process.stderr.columns-o.length-3),s=Math.min(r,a),n=Math.round(s*t),i="#".repeat(n),l="-".repeat(s-n);var c;c=process.stderr,chalk.supportsColor?y.cursorTo(c,0):c.write("\r"),process.stderr.write(`[${i}${l}]${o}`)},P=new class extends m{constructor(){super(),this._progress=-1}get progress(){return this._progress}set progress(e){this._progress=e,this.emit("progress",e)}get enabled(){return-1!==this._progress}set enabled(e){this.progress=e?0:-1}log(e){this.emit("log",e)}},b={npm:{installDeps:["install","--loglevel","error"],installPackages:["install","--loglevel","error"],uninstallPackages:["uninstall","--loglevel","error"],updatePackages:["update","--loglevel","error"]},pnpm:{installDeps:["install","--loglevel","error","--shamefully-flatten"],installPackages:["install","--loglevel","error"],uninstallPackages:["uninstall","--loglevel","error"],updatePackages:["update","--loglevel","error"]},yarn:{installDeps:[],installPackages:["add"],uninstallPackages:["remove"],updatePackages:["upgrade"]}},D=(e,r,t)=>new Promise(((o,a)=>{P.enabled=!1;const s=w(e,r,{cwd:t,stdio:["inherit","inherit","inherit"]});"yarn"===e&&s.stderr?.on("data",(e=>{const r=e.toString();if(/warning/.test(r))return;const t=r.match(/\[.*\] (\d+)\/(\d+)/);t?$(t[1],t[2]):process.stderr.write(e)})),s.on("close",(t=>{0===t?o():a(`command failed: ${e} ${r.join(" ")}`)}))})),x=(e=>{if(!b.npm.hasOwnProperty(e))throw new Error("Invalid method.");return async(...r)=>{const[t,o,a,s,n]=r;if(!["npm","yarn","pnpm"].includes(o))throw new Error(`package manager ${o} is not supported.`);const i=b[o][e];switch(e){case"installPackages":n&&i.push("-D");case"uninstallPackages":case"updatePackages":s.split(" ").forEach((e=>i.push(e)))}await D(o,i,t)}})("installDeps");class S extends m{constructor(e,r){super(),this.appName=e,this.targetDir=r}async create(e={}){this.repo=await this.inquireRepoInfo(),this.tag=await this.inquireTagInfo(),console.log(`You have selected ${r.yellow(this.repo,this.tag)}\n       as a template.`),l.mkdirSync(this.targetDir),await this.download(),await this.installDeps(),this.success()}async inquireRepoInfo(){return j()}async inquireTagInfo(){return q(this.repo)}async download(){await(async(e,r,t)=>{const o=`zhurong-cli/${e}${r?"#"+r:""}`;console.log(o);const a=h(u);await k(a,"fetching templates...",o,t)})(this.repo,this.tag,this.targetDir)}async installDeps(){console.log("ctx: ",this.targetDir),await x(this.targetDir,"yarn")}success(){console.clear(),console.log(`\n        \r\n${r.green("Successfully")} created project ${r.cyan(this.appName)}\n        \r\n cd ${r.cyan(this.appName)}\n        \r\n npm run dev\n      `)}}const I=(e,t)=>async(...o)=>{try{const r=(await k(t,`fetching ${e.name} information...`,...o)).map((e=>e.name)),a=await new c.prompt(((e,r)=>[{...e,choices:r}])(e,r));return a[e.name]}catch(e){console.log(r.red(e))}},j=I({name:"repo",type:"list",message:"Please choose a template"},(async()=>v.get("/orgs/zhurong-cli/repos"))),q=I({name:"repo",type:"list",message:"Please choose a version"},(async e=>v.get(`/repos/zhurong-cli/${e}/tags`))),N=[{name:"willOverwrite",type:"list",message:"Target directory exists. Shall it be overwriten ?",choices:[{name:"Overwrite",value:!0},{name:"Cancel",value:!1}]}],O=async(e,t)=>{if(l.existsSync(e))try{if(!t){console.clear();const{willOverwrite:e}=await new c.prompt(N);if(!e)return console.error(r.yellow("\n ⚠️  Creation have been canceled.")),!1}return console.log("\n ⚠️ The old directory will be removed."),await k(l.remove,"deleting old directory...",e),!0}catch(e){return console.log(r.red(e)),!1}return!0},T=a(s(import.meta.url));console.log(T);const C=(async e=>await l.readJSON(e))(i(T,"../package.json"));e.on("--help",(()=>{console.log("\n"+r.cyanBright.bold(t.textSync("onlyy",{font:"3D-ASCII",horizontalLayout:"default",verticalLayout:"default",width:80,whitespaceBreak:!0}))),console.log(`Run ${r.cyan("onlyy-cli < command > --help")} for detailed usage of given command.`)})),e.name("onlyy").usage("<command> [options]").version(`onlyy-cli ${C.version}`),e.name("onlyy-cli").command("create <project-name>").description("You are trying to create a new project ...").option("-p, --preset <presetName>","Skip prompts and use saved or remote preset").option("-d, --default","Skip prompts and use default preset").option("-f, --force","Skip prompts and overwrite target directory if it exists").action(((e,t)=>{o(process.argv.slice(3))._.length>1&&console.log(r.yellow("\n ⚠️  Detected more than one name arguments inputed, only the 1st will be used as project name and others are aborted.")),(async(e,t={})=>{const o=t.cwd||process.cwd();e="."===e?n("../",o):e;const a=p(e);a.validForNewPackages||(console.error(r.red(`Invalid project name: "${e}\n"`)),a.errors?.forEach((e=>console.error("❌ "+r.red.dim(e)))),a.warnings?.forEach((e=>console.warn("⚠️ "+r.yellow.dim(e)))),f(1));const s=i(o,e);if(!await O(s,t.force))return;console.log(r.blue.bold("sstart"));const l=new S(e,s);await l.create(t)})(e,t)})),e.name("oblyy").command("page <page-name>").description("Create a new page").option("-f, --force","Overwrite target directory if it exists").action(((e,r)=>{cleanArgs(r)})),e.parse(process.argv);
