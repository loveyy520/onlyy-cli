import{program as e}from"commander";import t from"chalk";import r from"figlet";import o from"minimist";import{dirname as a}from"node:path";import{fileURLToPath as s}from"node:url";import{relative as n,resolve as i}from"path";import l from"fs-extra";import c from"inquirer";import p from"validate-npm-package-name";import m from"events";import d from"axios";import g from"ora";import u from"download-git-repo";import{promisify as h}from"util";import{execa as y}from"execa";import w from"readline";import{exit as f}from"process";const v=d.create({timeout:6e4,baseURL:"https://api.github.com"});v.interceptors.request.use((e=>e)),v.interceptors.response.use((e=>e.data));const k=async(e,t,...r)=>{const o=g(t);try{o.start();const t=await e(...r);return o.succeed(),t}catch(s){return o.fail("failed to fetch resouorces, retrying..."),await(a=1,new Promise((e=>{setTimeout(e,1e3*a)}))),k(e,t,...r)}var a};const $=(e,t)=>{console.log("render processbar");const r=Math.min(Math.max(e/t,0),1),o=` ${e}/${t}`,a=Math.max(0,process.stderr.columns-o.length-3),s=Math.min(t,a),n=Math.round(s*r),i="#".repeat(n),l="-".repeat(s-n);var c;c=process.stderr,chalk.supportsColor?w.cursorTo(c,0):c.write("\r"),process.stderr.write(`[${i}${l}]${o}`)},P=new class extends m{constructor(){super(),this._progress=-1}get progress(){return this._progress}set progress(e){this._progress=e,this.emit("progress",e)}get enabled(){return-1!==this._progress}set enabled(e){this.progress=e?0:-1}log(e){this.emit("log",e)}},b={npm:{installDeps:["install","--loglevel","error"],installPackages:["install","--loglevel","error"],uninstallPackages:["uninstall","--loglevel","error"],updatePackages:["update","--loglevel","error"]},pnpm:{installDeps:["install","--loglevel","error","--shamefully-flatten"],installPackages:["install","--loglevel","error"],uninstallPackages:["uninstall","--loglevel","error"],updatePackages:["update","--loglevel","error"]},yarn:{installDeps:[],installPackages:["add"],uninstallPackages:["remove"],updatePackages:["upgrade"]}},D=(e,t,r)=>new Promise(((o,a)=>{P.enabled=!1;const s=y(e,t,{cwd:r,stdio:["inherit","inherit","inherit"]});"yarn"===e&&s.stderr?.on("data",(e=>{const t=e.toString();if(/warning/.test(t))return;const r=t.match(/\[.*\] (\d+)\/(\d+)/);r?$(r[1],r[2]):process.stderr.write(e)})),s.on("close",(r=>{0===r?o():a(`command failed: ${e} ${t.join(" ")}`)}))})),x=(e=>{if(!b.npm.hasOwnProperty(e))throw new Error("Invalid method.");return async(...t)=>{const[r,o,a,s,n]=t;if(!["npm","yarn","pnpm"].includes(o))throw new Error(`package manager ${o} is not supported.`);const i=b[o][e];switch(e){case"installPackages":n&&i.push("-D");case"uninstallPackages":case"updatePackages":s.split(" ").forEach((e=>i.push(e)))}await D(o,i,r)}})("installDeps");class S extends m{constructor(e,t){super(),this.appName=e,this.targetDir=t}async create(e={}){this.repo="onlyy-templates",this.tag=await this.inquireTagInfo(),console.log(`You have selected ${t.yellow(this.repo,this.tag)}\n       as a template.`),l.mkdirSync(this.targetDir),console.log(this.repo,this.tag),await this.download(),await this.installDeps(),this.success()}async inquireRepoInfo(){return inquireRepoInfo()}async inquireTagInfo(){return I(this.repo)}async download(){await(async(e,t,r)=>{const o=`loveyy520/${e}${t?"#"+t:""}`;console.log(o);const a=h(u);await k(a,"fetching templates...",o,r)})(this.repo,this.tag,this.targetDir)}async installDeps(){console.log("ctx: ",this.targetDir),await x(this.targetDir,"yarn")}success(){console.clear(),console.log(`\n        \r\n${t.green("Successfully")} created project ${t.cyan(this.appName)}\n        \r\n cd ${t.cyan(this.appName)}\n        \r\n npm run dev\n      `)}}const I=(j={name:"repo",type:"list",message:"Please choose a version"},q=async()=>v.get("/repos/loveyy520/onlyy-templates/tags"),async(...e)=>{try{const t=(await k(q,`fetching ${j.name} information...`,...e)).map((e=>e.name)),r=await new c.prompt(((e,t)=>[{...e,choices:t}])(j,t));return r[j.name]}catch(e){console.log(t.red(e))}});var j,q;const N=[{name:"willOverwrite",type:"list",message:"Target directory exists. Shall it be overwriten ?",choices:[{name:"Overwrite",value:!0},{name:"Cancel",value:!1}]}],O=async(e,r)=>{if(l.existsSync(e))try{if(!r){console.clear();const{willOverwrite:e}=await new c.prompt(N);if(!e)return console.error(t.yellow("\n ⚠️  Creation have been canceled.")),!1}return console.log("\n ⚠️ The old directory will be removed."),await k(l.remove,"deleting old directory...",e),!0}catch(e){return console.log(t.red(e)),!1}return!0},T=a(s(import.meta.url)),C=(async e=>await l.readJSON(e))(i(T,"../package.json"));e.on("--help",(()=>{console.log("\n"+t.cyanBright.bold(r.textSync("onlyy",{font:"3D-ASCII",horizontalLayout:"default",verticalLayout:"default",width:80,whitespaceBreak:!0}))),console.log(`Run ${t.cyan("onlyy-cli < command > --help")} for detailed usage of given command.`)})),e.name("onlyy").usage("<command> [options]").version(`onlyy-cli ${C.version}`),e.name("onlyy-cli").command("create <project-name>").description("You are trying to create a new project ...").option("-p, --preset <presetName>","Skip prompts and use saved or remote preset").option("-d, --default","Skip prompts and use default preset").option("-f, --force","Skip prompts and overwrite target directory if it exists").action(((e,r)=>{o(process.argv.slice(3))._.length>1&&console.log(t.yellow("\n ⚠️  Detected more than one name arguments inputed, only the 1st will be used as project name and others are aborted.")),(async(e,r={})=>{const o=r.cwd||process.cwd();e="."===e?n("../",o):e;const a=p(e);a.validForNewPackages||(console.error(t.red(`Invalid project name: "${e}\n"`)),a.errors?.forEach((e=>console.error("❌ "+t.red.dim(e)))),a.warnings?.forEach((e=>console.warn("⚠️ "+t.yellow.dim(e)))),f(1));const s=i(o,e);if(!await O(s,r.force))return;console.log(t.blue.bold("sstart"));const l=new S(e,s);await l.create(r)})(e,r)})),e.name("oblyy").command("page <page-name>").description("Create a new page").option("-f, --force","Overwrite target directory if it exists").action(((e,t)=>{cleanArgs(t)})),e.parse(process.argv);
